@using BlazorProject.Data
@using Microsoft.VisualBasic.CompilerServices
@attribute [Route(PageRoutes.Edit_Asset_Type)]
@inject AssetRepository AssetRepository
@inject ILogger<EditAssetType> Logger
@inject IJSRuntime JS

<h2>@nameof(PageRoutes.Edit_Asset_Type).Replace("_", " ")</h2>

<br/>

@* NOTE: Mud Dropzone *@
<h3 style="margin-top: 150px">With Mud Dropzone</h3>

<MudDropContainer
    T="Asset"
    Items="AllAssets"
    ItemsSelector="@((item, dropzone) => item.Type.ToString() == dropzone)"
    ItemDropped="ItemUpdatedAsync"
    Class="dropContainer"
>
    <ChildContent>
        @foreach (var type in Enum.GetValues<AssetType>()) {
            <MudDropZone
                T="Asset"
                Identifier="@type.ToString()"
                Class="dropZone"
            >
                <MudText Typo="Typo.h6" Class="mb-4" >
                    @type
                </MudText>
            </MudDropZone>
        }
    </ChildContent>
    <ItemRenderer>
        <MudPaper
            Elevation="25"
            Class="pa-4 my-4"
        >
            @context.Name
        </MudPaper>
    </ItemRenderer>
</MudDropContainer>

<br/>

@* NOTE: BlazorSortable *@
<h3 style="margin-top: 150px">With BlazorSortable</h3>

<div class="dropContainer">
    @foreach (var type in Enum.GetValues<AssetType>()) {
        <div class="dropZone">
            <MudText Typo="Typo.h6" Class="mb-4" >
                @type
            </MudText>

            <Sortable
                Items="AllAssets.Where(a => a.Type == type).ToList()"
                Id="@type.ToString()"
                Group="Group1"
                OnAdd="ItemUpdatedAsync"
            >
                <MudPaper Elevation="25" Class="pa-4 my-4" >
                    @context.Name
                </MudPaper>
            </Sortable>
        </div>
    }
</div>

<br/>

@* NOTE: With my own JS *@
<h3 style="margin-top: 150px">With my own JS</h3>

<div class="dropContainer">
    @foreach (var type in Enum.GetValues<AssetType>()) {
        <div class="dropZone data-drop-zone" data-dropZone="true" >
            <MudText Typo="Typo.h6" Class="mb-4">
                @type
            </MudText>

            @foreach (var asset in AllAssets.Where(a => a.Type == type)) {
                <div draggable="true" data-draggable >
                    <MudPaper Elevation="25" Class="pa-4 my-4" >
                        @asset.Name
                    </MudPaper>
                </div>
            }
        </div>
    }
</div>

@* Extend scrolling *@
<div style="height: 600px"/>

@code {

    protected override async Task OnInitializedAsync() {
        AllAssets = await AssetRepository.GetAllAssetsAsync();
    }

    private List<Asset> AllAssets = [];

    // NOTE: For the Mud Dropzone
    private async Task ItemUpdatedAsync(MudItemDropInfo<Asset> dropItem) {
        dropItem.Item.Type = Enum.Parse<AssetType>(dropItem.DropzoneIdentifier);

        await AssetRepository.UpdateAssetAsync(dropItem.Item);
    }

    // NOTE: For BlazorSortable
    private async void ItemUpdatedAsync(SortableEventArgs<Asset> eventArgs) {
        Logger.LogInformation("Changed type to {type}", eventArgs.To.Id);

        eventArgs.Item.Type = Enum.Parse<AssetType>(eventArgs.To.Id);

        await AssetRepository.UpdateAssetAsync(eventArgs.Item);
    }

    // NOTE: With my own JS
    protected override async Task OnAfterRenderAsync(bool firstRender) {
        if (!firstRender) return;

        var module = await JS.InvokeAsync<IJSObjectReference>(
            "import", "./Components/Pages/EditAssetType.razor.js");

        await module.InvokeVoidAsync("initialize");
    }
}